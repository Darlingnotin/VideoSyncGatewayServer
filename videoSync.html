<html>

<head>
  <title>Video Sync</title>
  <style>
    #video {
      width: auto;
      height: 100%;
    }

    #video-container-play-button {
      width: 100vw;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center center;
      background-color: rgba(0, 0, 0, 0.5);
      background-image: url('assets/play_btn.png');
    }

    *::-webkit-media-controls-panel {
      display: none !important;
      -webkit-appearance: none;
    }

    div.volumeIs {
      position: absolute;
      top: 20px;
    }

    strong {
      background: rgba(0, 0, 0, 0.5);
      display: inline-block;
      border-radius: 16px;
      padding: 0 20px;
    }

    .slider {
      position: absolute;
      right: 5%;
      top: 95%;
      width: 300px;
      background-color: honeydew;
    }

    #fullscreen {
      position: absolute;
      left: 5%;
      top: 95%;
      width: 120px;
      height: 30px;
    }
  </style>
</head>

<body bgcolor="#333333" onload="prepareWebsocketUrl()">
  <center>
    <div id="video-container" onclick="requestSync()">
      <video id="video" poster="assets/clickToWatch.png" controls autoplay>
        <source id="mp4_src" src=" " type="video/webm">
      </video><br>
  </center>
  <input hidden type="range" min="0" max="1" value="1" step="0.01" class="slider" id="volumeSlider">
  <button hidden id="fullscreen" onclick="fullscreen()">Fullscreen</button>
  </div>

  <script>

    var firstTime = true;
    var myTimeStamp = Date.now();
    var HasBeenClicked = false;
    var videoLoaded = false;
    var wsUrl;
    var ws;
    document.onkeydown = checkKey;

    function prepareWebsocketUrl() {
      var currURL;
      Url = window.open(currURL, "_self").location.hostname;
      wsUrl = "ws://" + Url + ":7080/";
      var slider = document.getElementById("volumeSlider");
      var timeoutIs = false;
      slider.oninput = function () {
        if (!timeoutIs) {
          setTimeout(() => {
            timeoutIs = false;
            video = document.getElementById('video');
            video.volume = this.value;
          }, 300);
          timeoutIs = true;
        }
      }
      openWebSocket();
    }

    function fullscreen() {
      var video = document.getElementById("video");
      if (video.requestFullscreen) {
        video.requestFullscreen();
      } else if (video.mozRequestFullScreen) {
        video.mozRequestFullScreen();
      } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
      } else if (video.msRequestFullscreen) {
        video.msRequestFullscreen();
      }
    }

    function checkKey(e) {

      e = e || window.event;
      console.log(e.keyCode);
      if (e.keyCode == '86') {
        var isHidden = document.getElementById("volumeSlider").hidden;
        if (isHidden) {
          document.getElementById("volumeSlider").hidden = false;
          document.getElementById("fullscreen").hidden = false;
        } else if (!isHidden) {
          document.getElementById("volumeSlider").hidden = true;
          document.getElementById("fullscreen").hidden = true;
        }
      }
    }

    function openWebSocket() {
      ws = new WebSocket(wsUrl);
      ws.onopen = function () {
        console.log("Web Socket Onopen");
      }
      ws.onmessage = function (evt) {
        websocketMessageReceived(evt.data);
      }
      ws.onclose = function () {
        console.log("Web Socket Close");
        setTimeout(() => {
          openWebSocket();
        }, 1000);
      }
    }

    function requestSync() {
      if (firstTime) {
        HasBeenClicked = true;
        var readyEvent = {
          action: 'requestSync',
          myTimeStamp: myTimeStamp
        };
        ws.send(JSON.stringify(readyEvent));
        console.log(JSON.stringify(readyEvent));
      }
    }

    function websocketMessageReceived(message) {
      var messageData = JSON.parse(message);
      if (messageData.action == 'play' && !firstTime) {
        document.getElementById('video').play();
        document.getElementById('video').currentTime = messageData.timeStamp;
      } else if (messageData.action == 'pause' && !firstTime) {
        document.getElementById('video').pause();
      } else if (messageData.action == 'now' && messageData.myTimeStamp != myTimeStamp) {
        if (!firstTime || HasBeenClicked) {
          document.getElementById('video').src = messageData.videoUrl;
          firstTime = false;
        }
      } else if (messageData.action == 'sync' && messageData.myTimeStamp == myTimeStamp) {
        console.log(JSON.stringify(messageData));
        if (firstTime) {
          document.getElementById('video').src = messageData.videoUrl;
          document.getElementById('video').currentTime = messageData.timeStamp;
          firstTime = false;
          if (!messageData.videoPlaying) {
            var vid = document.getElementById("video");
            vid.onloadeddata = function () {
              document.getElementById('video').pause();
            };
          }
        }
      } else if (messageData.action == 'ping' && !firstTime) {
        var video = document.getElementById('video');
        var myVideoCurrentTimeStamp = video.currentTime;
        var ping = messageData.timeStamp;
        if (ping + 2 > myVideoCurrentTimeStamp && ping - 2 < myVideoCurrentTimeStamp) {
        } else {
          document.getElementById('video').currentTime = messageData.timeStamp;
        }
      } else if (messageData.action == "nowVideoFromTablet") {
        videoLoaded = false;
        document.getElementById('video').src = messageData.videoUrl;
        firstTime = false;
        var v = document.getElementById('video');
        v.onloadeddata = function () {
          videoLoaded = true;
        };
        var videoLoadedSendMessageInterval = setInterval(() => {
          if (videoLoaded) {
            var v = document.getElementById('video');
            var readyEvent = {
              action: "now",
              videoUrl: messageData.videoUrl,
              length: v.duration,
              timeStamp: v.currentTime,
              myTimeStamp: myTimeStamp
            };
            ws.send(JSON.stringify(readyEvent));
            //EventBridge.emitWebEvent(JSON.stringify(readyEvent));
            clearInterval(videoLoadedSendMessageInterval);
            videoLoaded = false;
          }
        }, 100);
      } else if (messageData.action == "buttonAction") {
        if (messageData.buttonAction == "leave") {
          document.getElementById('video').src = "http://";
          firstTime = true;
          HasBeenClicked = false;
        } else if (messageData.buttonAction == "volumeButtonMinus") {
          var video = document.getElementById('video');
          var volume = video.volume;
          var chosenVolume;
          if (volume - 0.1 < 0.1) {
            chosenVolume = 0;
          } else {
            chosenVolume = volume - 0.1;
          }
          video.volume = chosenVolume.toFixed(1);
        } else if (messageData.buttonAction == "volumeButtonPlus") {
          var video = document.getElementById('video');
          var volume = video.volume;
          var chosenVolume;
          if (video.volume.toFixed(1) == 1) {
            chosenVolume = 1;
          } else {
            chosenVolume = volume + 0.1;
          }
          video.volume = chosenVolume.toFixed(1);
        } else if (messageData.buttonAction == "pause" && !firstTime) {
          sendButtonAction(messageData.buttonAction);
        } else if (messageData.buttonAction == "play" && !firstTime) {
          sendButtonAction(messageData.buttonAction);
        }
      } else if (messageData.action == "RequestVideoLengthAndTimeStamp") {
        var v = document.getElementById('video');
        var readyEvent = {
          action: "RequestVideoLengthAndTimeStampResponse",
          length: v.duration,
          timeStamp: v.currentTime,
          myTimeStamp: messageData.myTimeStamp
        };
        ws.send(JSON.stringify(readyEvent));
        //EventBridge.emitWebEvent(JSON.stringify(readyEvent));
      } else if (messageData.action == "volumeSlider") {
        video = document.getElementById('video');
        video.volume = parseFloat(messageData.volume);
      }
    }

    function sendButtonAction(buttonAction) {
      var readyEvent = {
        "action": buttonAction,
        "timeStamp": document.getElementById('video').currentTime,
        "nowVideo": "false"
      };
      ws.send(JSON.stringify(readyEvent));
      //EventBridge.emitWebEvent(JSON.stringify(readyEvent));
    }

    vid = document.getElementById('myVideo');
  </script>

</body>

</html>